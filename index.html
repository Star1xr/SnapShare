<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnapBridge Ultra | Professional P2P</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --accent: #00ff88;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: #fff;
            height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }

        .main-card {
            width: 100%; max-width: 450px; height: 90vh; background: var(--glass);
            backdrop-filter: blur(40px); border: 1px solid var(--border); border-radius: 40px;
            display: flex; flex-direction: column; padding: 30px; box-shadow: 0 20px 80px rgba(0,0,0,0.6);
        }

        .header h1 { font-size: 1.8rem; margin: 0; font-weight: 800; letter-spacing: -1px; text-align: center; margin-bottom: 25px; }
        
        .code-box {
            background: rgba(0,0,0,0.4); border-radius: 24px; padding: 20px;
            text-align: center; border: 1px solid var(--border); margin-bottom: 20px;
        }

        .code-label { font-size: 0.65rem; text-transform: uppercase; color: var(--accent); letter-spacing: 2px; margin-bottom: 8px; }
        .short-code { font-family: 'JetBrains Mono', monospace; font-size: 2.2rem; font-weight: 700; color: #fff; }

        .input-group { display: flex; gap: 10px; margin-bottom: 25px; }
        .input-field {
            flex: 1; background: var(--glass); border: 1px solid var(--border);
            border-radius: 16px; padding: 15px; color: #fff; font-family: 'JetBrains Mono', monospace;
        }

        .btn {
            background: #fff; color: #000; border: none; border-radius: 16px;
            padding: 15px 25px; font-weight: 800; cursor: pointer; transition: 0.2s;
        }
        .btn:hover { background: var(--accent); transform: scale(1.02); }

        .transfer-area { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        
        .log-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px; }

        .card-item {
            background: rgba(255,255,255,0.03); border-radius: 18px; padding: 16px;
            border: 1px solid var(--border);
        }

        .prog-bg { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 10px 0; overflow: hidden; }
        .prog-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.1s; }

        .status-msg { font-size: 0.75rem; font-weight: 700; color: var(--accent); }

        .controls { display: flex; gap: 10px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 24px; border: 1px solid var(--border); }
        .file-btn { flex: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="main-card">
    <div class="header">
        <h1>SnapBridge <span style="color:var(--accent)">Ultra</span></h1>
    </div>

    <div id="setup-screen">
        <div class="code-box">
            <div class="code-label">Access Code</div>
            <div id="display-code" class="short-code">Loading...</div>
        </div>
        <div class="input-group">
            <input type="text" id="join-code" class="input-field" placeholder="Target Code" maxlength="6">
            <button class="btn" onclick="startConnect()">Connect</button>
        </div>
    </div>

    <div id="transfer-screen" class="transfer-area">
        <div id="log-list" class="log-list"></div>
        <div class="controls">
            <label class="file-btn">
                <input type="file" id="files" class="hidden" multiple>
                <span>ðŸ“‚ Upload</span>
            </label>
            <input type="text" id="text-msg" class="input-field" style="margin:0; padding:10px" placeholder="Link...">
            <button class="btn" style="padding:10px 20px" onclick="sendText()">Send</button>
        </div>
    </div>
</div>

<script>
    const PREFIX = "SB-"; // Arka planda Ã§akÄ±ÅŸmayÄ± Ã¶nleyen Ã¶n ek
    const genCode = () => Math.random().toString(36).substring(2, 8).toLowerCase();
    const myShortCode = genCode();
    document.getElementById('display-code').innerText = myShortCode;

    const peer = new Peer(PREFIX + myShortCode, {
        config: {'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }]}
    });

    let conn;
    let buffers = {};

    peer.on('connection', c => { conn = c; initHandlers(); });

    function startConnect() {
        const target = document.getElementById('join-code').value.toLowerCase();
        conn = peer.connect(PREFIX + target, { reliable: true });
        initHandlers();
    }

    function initHandlers() {
        conn.on('open', () => {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('transfer-screen').style.display = 'flex';
            conn.send({ type: 'hi' });
        });
        conn.on('data', d => {
            if(d.type === 'hi') {
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('transfer-screen').style.display = 'flex';
            }
            handleData(d);
        });
    }

    function handleData(d) {
        if(d.type === 'txt') addLog('Peer', d.val);
        if(d.type === 'f-start') {
            buffers[d.id] = { chunks: [], meta: d };
            renderItem(d.id, d.name, 'Receiving');
        }
        if(d.type === 'f-chunk') {
            const b = buffers[d.id];
            b.chunks.push(d.chunk);
            updateBar(d.id, Math.round((b.chunks.length / d.total) * 100));
            if(b.chunks.length === d.total) {
                const url = URL.createObjectURL(new Blob(b.chunks, { type: b.meta.mime }));
                finishItem(d.id, url, b.meta.name);
            }
        }
    }

    document.getElementById('files').addEventListener('change', async (e) => {
        for (let f of e.target.files) {
            const fid = Math.random().toString(36).substr(2, 6);
            renderItem(fid, f.name, 'Sending');
            const total = Math.ceil(f.size / 16384);
            conn.send({ type: 'f-start', id: fid, name: f.name, mime: f.type, total });

            let i = 0;
            const reader = f.stream().getReader();
            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                let offset = 0;
                while(offset < value.length) {
                    const chunk = value.slice(offset, offset + 16384);
                    conn.send({ type: 'f-chunk', id: fid, chunk, index: i, total });
                    offset += 16384; i++;
                    updateBar(fid, Math.round((i/total)*100));
                }
            }
            document.getElementById('st-'+fid).innerText = 'âœ“ SENT SUCCESSFUL';
        }
    });

    function sendText() {
        const v = document.getElementById('text-msg').value;
        if(v && conn?.open) { conn.send({type:'txt', val:v}); addLog('You', v); document.getElementById('text-msg').value=''; }
    }

    function renderItem(id, name, mode) {
        const div = document.createElement('div');
        div.className = 'card-item';
        div.id = 'it-'+id;
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-size:0.8rem">
                <span style="font-weight:600">${name}</span>
                <span id="st-${id}" class="status-msg">${mode.toUpperCase()}...</span>
            </div>
            <div class="prog-bg"><div id="br-${id}" class="prog-bar"></div></div>
        `;
        document.getElementById('log-list').prepend(div);
    }

    function updateBar(id, p) { 
        const b = document.getElementById('br-'+id); 
        if(b) b.style.width = p+'%'; 
    }

    function finishItem(id, url, name) {
        document.getElementById('st-'+id).innerHTML = `<a href="${url}" download="${name}" style="color:var(--accent); text-decoration:none">âœ“ SAVE FILE</a>`;
    }

    function addLog(who, msg) {
        const div = document.createElement('div');
        div.className = 'card-item';
        div.innerHTML = `<div style="font-size:0.65rem; color:var(--accent); font-weight:800; margin-bottom:4px">${who.toUpperCase()}</div><div style="font-size:0.9rem">${msg}</div>`;
        document.getElementById('log-list').prepend(div);
    }
</script>
</body>
</html>
