<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnapBridge Ultra | High-Speed Bridge</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #030303;
            --accent: #00ff88;
            --accent-glow: rgba(0, 255, 136, 0.3);
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: #fff;
            height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }

        .main-card {
            width: 100%; max-width: 500px; height: 95vh; background: var(--glass);
            backdrop-filter: blur(30px); border: 1px solid var(--border); border-radius: 40px;
            display: flex; flex-direction: column; padding: 30px; box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }

        .header { text-align: left; margin-bottom: 30px; }
        .header h1 { font-size: 2rem; margin: 0; font-weight: 800; letter-spacing: -1px; }
        
        .code-display {
            background: rgba(0,0,0,0.4); border-radius: 20px; padding: 25px;
            text-align: center; border: 1px solid var(--border); margin-bottom: 25px;
        }

        .code-label { font-size: 0.7rem; text-transform: uppercase; color: var(--accent); letter-spacing: 2px; margin-bottom: 10px; }
        .short-code { font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700; color: #fff; text-shadow: 0 0 15px var(--accent-glow); }

        .join-area { display: flex; gap: 10px; margin-bottom: 30px; }
        .input-code {
            flex: 1; background: var(--glass); border: 1px solid var(--border);
            border-radius: 15px; padding: 15px; color: #fff; font-family: 'JetBrains Mono', monospace; font-size: 1.1rem;
        }

        .btn {
            background: #fff; color: #000; border: none; border-radius: 15px;
            padding: 15px 25px; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .btn:hover { transform: scale(1.05); background: var(--accent); }

        .transfer-zone { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        
        .log-container {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
            margin-bottom: 20px; padding-right: 5px;
        }

        .item {
            background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px;
            border: 1px solid var(--border); transition: 0.3s;
        }

        .progress-wrapper { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 10px 0; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.1s; box-shadow: 0 0 10px var(--accent-glow); }

        .success-text { color: var(--accent); font-weight: bold; font-size: 0.8rem; }

        .action-bar { display: flex; gap: 10px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 20px; border: 1px solid var(--border); }
        .file-label { flex: 1; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9rem; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="main-card">
    <div class="header">
        <h1>SnapBridge <span style="color:var(--accent)">U</span></h1>
        <div id="status" style="font-size: 0.75rem; opacity: 0.5;">Initializing Engine...</div>
    </div>

    <div id="setup-view">
        <div class="code-display">
            <div class="code-label">Your Local Access Code</div>
            <div id="my-code" class="short-code">------</div>
        </div>

        <div class="join-area">
            <input type="text" id="target-id" class="input-code" placeholder="Enter 6-char code" maxlength="6">
            <button class="btn" onclick="connect()">Connect</button>
        </div>
    </div>

    <div id="transfer-view" class="transfer-zone">
        <div class="log-container" id="log-container"></div>
        
        <div class="action-bar">
            <label class="file-label">
                <input type="file" id="file-input" class="hidden" multiple>
                <span>üìÅ Upload Media</span>
            </label>
            <input type="text" id="text-input" class="input-code" style="margin:0; padding:10px" placeholder="Type link...">
            <button class="btn" style="padding:10px 20px" onclick="sendMsg()">Send</button>
        </div>
    </div>
</div>

<script>
    const generateShortId = () => {
        const chars = 'abcdefghjkmnpqrstuvwxyz23456789';
        let result = '';
        for (let i = 0; i < 6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        return result;
    };

    const myId = generateShortId();
    document.getElementById('my-code').innerText = myId;

    const peer = new Peer(myId, {
        config: {'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478' }]}
    });

    let conn;
    let fileBuffers = {};

    peer.on('open', () => document.getElementById('status').innerText = "System Live - Ready to Bridge");
    peer.on('connection', c => { conn = c; setupPeer(); });

    function connect() {
        const target = document.getElementById('target-id').value.toLowerCase();
        if (target.length === 6) {
            conn = peer.connect(target, { reliable: false }); // High speed mode
            setupPeer();
        }
    }

    function setupPeer() {
        conn.on('open', () => {
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('transfer-view').style.display = 'flex';
            document.getElementById('status').innerText = "Encrypted Connection Established";
            conn.send({ type: 'init' });
        });

        conn.on('data', data => {
            if (data.type === 'init') {
                document.getElementById('setup-view').classList.add('hidden');
                document.getElementById('transfer-view').style.display = 'flex';
            }
            handleIncoming(data);
        });
    }

    function handleIncoming(data) {
        if (data.type === 'msg') addLog('Peer', data.val);
        if (data.type === 'file-start') {
            fileBuffers[data.id] = { chunks: [], meta: data };
            renderFileItem(data.id, data.name, 'downloading');
        }
        if (data.type === 'file-chunk') {
            const fb = fileBuffers[data.id];
            fb.chunks.push(data.chunk);
            const p = Math.round((fb.chunks.length / data.total) * 100);
            updateProgress(data.id, p);

            if (fb.chunks.length === data.total) {
                const blob = new Blob(fb.chunks, { type: fb.meta.mime });
                finalizeFile(data.id, URL.createObjectURL(blob));
            }
        }
    }

    document.getElementById('file-input').addEventListener('change', async (e) => {
        for (let file of e.target.files) {
            const fid = Math.random().toString(36).substr(2, 6);
            renderFileItem(fid, file.name, 'uploading');
            
            conn.send({ type: 'file-start', id: fid, name: file.name, mime: file.type, total: Math.ceil(file.size / 16384) });

            const reader = file.stream().getReader();
            let index = 0;
            const total = Math.ceil(file.size / 16384);

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                // Chunking for zero-crash memory management
                let offset = 0;
                while (offset < value.length) {
                    const chunk = value.slice(offset, offset + 16384);
                    conn.send({ type: 'file-chunk', id: fid, chunk: chunk, index: index, total: total });
                    offset += 16384;
                    index++;
                    updateProgress(fid, Math.round((index/total)*100));
                }
            }
            document.getElementById(`status-${fid}`).innerHTML = '<span class="success-text">‚úì SENT SUCCESSFUL</span>';
        }
    });

    function sendMsg() {
        const val = document.getElementById('text-input').value;
        if (val && conn?.open) {
            conn.send({ type: 'msg', val });
            addLog('You', val);
            document.getElementById('text-input').value = '';
        }
    }

    function renderFileItem(id, name, mode) {
        const div = document.createElement('div');
        div.className = 'item';
        div.id = `item-${id}`;
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                <span style="font-size:0.9rem; font-weight:600">${name}</span>
                <div id="status-${id}" style="font-size:0.7rem; opacity:0.6">${mode.toUpperCase()}...</div>
            </div>
            <div class="progress-wrapper"><div id="bar-${id}" class="progress-bar"></div></div>
        `;
        document.getElementById('log-container').prepend(div);
    }

    function updateProgress(id, percent) {
        const bar = document.getElementById(`bar-${id}`);
        if (bar) bar.style.width = percent + '%';
    }

    function finalizeFile(id, url) {
        const stat = document.getElementById(`status-${id}`);
        const name = document.getElementById(`item-${id}`).querySelector('span').innerText;
        stat.innerHTML = `<a href="${url}" download="${name}" class="success-text" style="text-decoration:none">‚úì SAVE FILE</a>`;
        document.getElementById(`bar-${id}`).style.background = 'var(--accent)';
    }

    function addLog(who, msg) {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div style="font-size:0.7rem; color:var(--accent); margin-bottom:5px">${who.toUpperCase()}</div><div>${msg}</div>`;
        document.getElementById('log-container').prepend(div);
    }
</script>

</body>
</html>
